# 统一认证系统集成文档

北京智麟科技有限公司

## 一、概述

### 1. 用途

本文档定义了一组 API 接口，其他系统（如财务系统、教务系统）可通过调用接口向统一身份认证系统进行集成。

### 2. 适用版本

本文档定义的接口规范，对全版本统一身份认证系统有效。

### 3. 通信协议



* 统一身份认证服务为通信服务器端（简称 “认证服务器”），调用接口的其他系统为第三方应用服务（简称 “第三方应用”），使用者为师生用户（简称 “用户”）。

* 第三方应用和认证服务器通过 HTTP/HTTPS 协议通信，第三方应用使用 HTTP Get/Post 发送请求，认证服务器返回操作结果或用户信息。

### 4. 调用方式



* 接口请求地址为 URL 地址，格式为 “接口位置 + 参数”，示例：`https://sso.edu.cn/serviceValidate?service=abc&ticket=st-123`。

* 文档中所有 “[https://sso.edu.cn](https://sso.edu.cn)” 需替换为实际应用地址，如 “[http://cas.edu.cn/tpass/](http://cas.edu.cn/tpass/)......”。

* URL 请求参数值包含保留字符（;/?:@&=+\$,”）时，需按 RFC2396 规范进行 URL 编码（替换为 % hexhex 形式），具体参考 HTTP 1.1 规范。



***

## 二、页面跳转集成接口

页面跳转登录方式为推荐方式，同等条件下建议优先使用，兼容 CAS 2.0、CAS 3.0 协议标准。

### 1. 登录流程

#### （1）首次登陆流程



1. 用户打开第三方应用，第三方应用验证登录状态（如 session cookie），未登录则重定向到认证服务器。

2. 认证服务器验证登录状态，未登录则展示登录页面。

3. 用户完成登录操作。

4. 认证服务器设置浏览器 cookie 的 CASTGC 内容，并重定向用户到第三方应用。

5. 第三方应用获取 ticket，调用认证服务器验证接口获取用户信息。

6. 第三方应用使用用户信息（如学工号、姓名）完成系统内登录逻辑（如设置 session）。

#### （2）登录后第二次访问同一个第三方应用流程



1. 用户打开第三方应用，第三方应用验证登录状态（如 session cookie）。

2. 已登录则直接展示内容页面。

#### （3）登录后首次访问第二个第三方应用流程



1. 用户打开第三方应用，第三方应用验证登录状态（如 session cookie），未登录则重定向到认证服务器。

2. 认证服务器通过 CASTGC 验证登录状态，有效则重定向用户到第三方应用。

3. 第三方应用获取 ticket，调用认证服务器验证接口获取用户信息。

4. 第三方应用使用用户信息完成系统内登录逻辑（如设置 session）。

### 2. 登录接口 /login



| 地址   | [https://sso.edu.cn/login](https://sso.edu.cn/login) |
| ---- | ---------------------------------------------------- |
| 调用方式 | GET                                                  |
| 参数   | service（必填）                                          |
| 调用场景 | 第三方应用判断用户未登录后，将用户重定向到该地址                             |

**示例**：



* 请求地址：`https://sso.edu.cn/login?service=http%3a%2f%2fcaiwu.edu.cn`

* 登录后重定向地址：`http://caiwu.edu.cn/sso?ticket=ST-123456`

### 3. 登出接口 /logout



| 地址   | [https://sso.edu.cn/logout](https://sso.edu.cn/logout)               |
| ---- | -------------------------------------------------------------------- |
| 调用方式 | GET                                                                  |
| 调用场景 | 用户在第三方应用点击注销 / 登出按钮后，第三方应用先调用后台接口使 session 失效，再重定向用户到该地址，使统一认证登录状态失效 |

**示例**：`https://sso.edu.cn/logout`

### 4. 票据验证接口 /serviceValidate



| 地址   | CAS 2.0：[https://sso.edu.cn/serviceValidate](https://sso.edu.cn/serviceValidate)；CAS 3.0：[https://sso.edu.cn/p3/serviceValidate](https://sso.edu.cn/p3/serviceValidate) |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 调用方式 | GET                                                                                                                                                                     |
| 参数   | service（必填）                                                                                                                                                             |
|      | ticket（必填）                                                                                                                                                              |
| 返回值  | XML 格式编码的调用结果，ticket 验证通过返回用户信息，否则返回错误信息                                                                                                                                |
| 调用场景 | 第三方应用获取到 ticket 后，调用该接口获取用户信息                                                                                                                                           |

**错误码**：



1. INVALID\_REQUEST - 请求参数错误

2. INVALID\_TICKET - ticket 验证失败

3. INVALID\_SERVICE - ticket 验证成功，但 service 不在白名单中

4. INTERNAL\_ERROR - 认证服务内部错误

**示例**：



* 请求地址：`https://sso.edu.cn/serviceValidate?service=http%3a%2f%2fcaiwu.edu.cn&ticket=ST-123456`

* 验证成功返回：



```
\<cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'>

\<cas:authenticationSuccess>

\<cas:user>username\</cas:user>

\<cas:name>张三\</cas:name>

\</cas:authenticationSuccess>

\<cas:employeeNumber>12345\</cas:employeeNumber>

\</cas:serviceResponse>
```



* 验证失败返回：



```
\<cas:serviceResponse xmlns:cas='http://www.yale.edu/tp/cas'>

\<cas:authenticationFailure code="INVALID\_TICKET">

Ticket ST-123456 not recognized

\</cas:authenticationFailure>

\</cas:serviceResponse>
```

